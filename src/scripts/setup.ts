import inquirer from 'inquirer';
import fs from 'fs';
import path from 'path';
import axios from 'axios';

export async function runSetup() {
  console.log('ğŸš€ Revolutionary MCP Browser Control Server Setup\n');
  console.log('ğŸ“‹ Configure Google API key for SEO intelligence features...\n');

  try {
    const config = await inquirer.prompt([
      {
        type: 'input',
        name: 'googleApiKey',
        message: 'ğŸ”‘ Enter your Google PageSpeed Insights API Key:',
        validate: async (input: string) => {
          if (!input || input.length < 10) {
            return 'API key is required for SEO features (minimum 10 characters)';
          }

          // Test API key validity
          console.log('\nğŸ§ª Testing API key...');
          try {
            const testUrl = 'https://www.googleapis.com/pagespeedonline/v5/runPagespeed';
            const response = await axios.get(testUrl, {
              params: {
                url: 'https://google.com',
                key: input,
                category: 'performance'
              },
              timeout: 10000
            });

            if (response.status === 200) {
              console.log('âœ… API key validated successfully!\n');
              return true;
            } else {
              return 'API key validation failed. Please check your key.';
            }
          } catch (error) {
            if (error.response?.status === 403) {
              return 'Invalid API key. Please check your Google API key.';
            } else if (error.response?.status === 429) {
              console.log('âš ï¸  Rate limit reached, but API key appears valid.\n');
              return true;
            } else {
              console.log('âš ï¸  Could not validate API key (network issue), but proceeding...\n');
              return true;
            }
          }
        }
      },
      {
        type: 'confirm',
        name: 'enableSEO',
        message: 'ğŸ“Š Enable advanced SEO intelligence features?',
        default: true
      },
      {
        type: 'confirm',
        name: 'enableMultimedia',
        message: 'ğŸ¥ Enable revolutionary multimedia testing?',
        default: true
      },
      {
        type: 'confirm',
        name: 'enableKeywordIntelligence',
        message: 'ğŸ” Enable keyword intelligence and competitive analysis?',
        default: true
      },
      {
        type: 'list',
        name: 'logLevel',
        message: 'ğŸ“ Select logging level:',
        choices: [
          { name: 'Info (Recommended)', value: 'info' },
          { name: 'Debug (Verbose)', value: 'debug' },
          { name: 'Warn (Minimal)', value: 'warn' },
          { name: 'Error (Critical only)', value: 'error' }
        ],
        default: 'info'
      },
      {
        type: 'list',
        name: 'browserMode',
        message: 'ğŸŒ Browser mode preference:',
        choices: [
          { name: 'Headless (Recommended for servers)', value: 'true' },
          { name: 'Visible (For development/testing)', value: 'false' }
        ],
        default: 'true'
      },
      {
        type: 'confirm',
        name: 'saveConfig',
        message: 'ğŸ’¾ Save configuration to .env file?',
        default: true
      }
    ]);

    if (config.saveConfig) {
      // Create .env file
      const envContent = `# MCP Browser Control Server Configuration
# Generated by setup wizard on ${new Date().toISOString()}

# REQUIRED: Google API Key for SEO Intelligence
GOOGLE_PAGESPEED_API_KEY=${config.googleApiKey}

# Feature Toggles
ENABLE_SEO_FEATURES=${config.enableSEO}
ENABLE_MULTIMEDIA_TESTING=${config.enableMultimedia}
ENABLE_KEYWORD_INTELLIGENCE=${config.enableKeywordIntelligence}

# Server Configuration
LOG_LEVEL=${config.logLevel}
HEADLESS_MODE=${config.browserMode}
SERVER_PORT=3000
MAX_CONCURRENT_SESSIONS=5

# Optional: Premium Features (Professional License Required)
# ENABLE_PDF_GENERATION=false
# ENABLE_PREMIUM_TEMPLATES=false

# Browser Configuration
DEFAULT_BROWSER=chrome
BROWSER_TIMEOUT=30000
SELENIUM_IMPLICIT_WAIT=10000

# Performance Settings
SCREENSHOT_QUALITY=80
PAGE_LOAD_TIMEOUT=30000
ELEMENT_TIMEOUT=10000
`;

      fs.writeFileSync('.env', envContent);

      console.log('\nâœ… Configuration saved to .env');
      console.log('ğŸ¯ Revolutionary SEO intelligence ready!');

      // Show next steps
      console.log('\nğŸ“‹ Next Steps:');
      console.log('  mcp-browser-control start              # Start the server');
      console.log('  mcp-browser-control test-config        # Test your setup');
      console.log('  mcp-browser-control analyze <url>      # Quick analysis demo');
      console.log('\nğŸ“– Documentation:');
      console.log('  GOOGLE-API-SETUP.md    # Complete setup guide');
      console.log('  README.md              # Platform documentation');
      console.log('  PDF-INTEGRATION.md     # Premium features guide');

      console.log('\nğŸš€ Revolutionary platform configured successfully!');
      console.log('ğŸ’ Ready to deliver â‚¬35,000+ SEO intelligence analysis!');

    } else {
      console.log('\nâš ï¸  Configuration not saved. Run setup again when ready.');
    }

  } catch (error) {
    console.log('\nâŒ Setup failed:', error.message);
    console.log('ğŸ“– Check GOOGLE-API-SETUP.md for manual configuration.');
    console.log('ğŸ’¼ Support: dimitrymd@gmail.com');
  }
}

// CLI entry point
if (import.meta.url === `file://${process.argv[1]}`) {
  runSetup().catch(console.error);
}